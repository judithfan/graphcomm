<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/snap.svg-min.js"></script>
    <script src="js/jspsych.js"></script>
    <script src="js/jspsych-nAFC-circle.js"></script>
    <script src="js/jspsych-instructions.js"></script>
    <script src="js/lodash.min.js"></script>
    <script src="js/object_list.js"></script>
    <link rel="stylesheet" href="./custom.css"></link>

    <script>
      window.onload = function() {

        var socket = io.connect();
        socket.on('onconnected', function(d) {
          var meta = d.meta;
          var id = d.id;

          // console.log('meta',meta);

          // high level experiment parameter (placeholder)
          var num_trials = meta.length;

          // define trial list
          var tmp = {
            type: 'nAFC-circle',
            num_trials: num_trials,
            target: _.map(meta, 'target'),
            sketch: _.map(meta, function(x) { return './sketch/' + x.filename }),
            category: _.map(meta, 'category'),
            distractor1: _.map(meta, 'Distractor1'),
            distractor2: _.map(meta, 'Distractor2'),
            distractor3: _.map(meta, 'Distractor3'),
            context: _.map(meta, 'condition'),
            draw_duration: _.map(meta, 'drawDuration'),
            num_strokes: _.map(meta, 'numStrokes'),
            viewer_correct_in_context: _.map(meta, 'outcome'),
            viewer_response_in_context: _.map(meta, 'response'),
            viewer_RT_in_context: _.map(meta, 'viewerRT'),
            original_gameID: _.map(meta,'gameID'),
            original_trialNum:_.map(meta,'trialNum'),
            sketch_size: [220,220],
            object_size: [70,70],
            circle_diameter: 800,
            options: object_list,
            set_size: 32,
            timing_sketch: 100,
            timing_objects: 1000
          };

          var trials = new Array(tmp.num_trials + 2);

          // add welcome page
          var welcome = {
              type: 'instructions',
              pages: [
                  'Welcome! On each trial, you will see a drawing appear, surrounded by an array of different objects. Your goal is to select the object in the ring that best matches the drawing.'.bold(),
                  'Welcome! On each trial, you will see a drawing appear, surrounded by an array of different objects. Your goal is to select the object in the ring that best matches the drawing.' + ' Hover over objects with the mouse cursor to enlarge them, and click the enlarged object only once you have made your final selection. It is very important that you consider the options carefully and try your best!'.bold(),
                  'Welcome! On each trial, you will see a drawing appear, surrounded by an array of different objects. Your goal is to select the object in the ring that best matches the drawing. Hover over objects with the mouse cursor to enlarge them, and click the enlarged object only once you have made your final selection. It is very important that you consider the options carefully and try your best!' + ' Please note that Once you are finished, the HIT will be automatically submitted for approval. Thanks!'.bold()
              ],
              show_clickable_nav: true
          }
          trials[0] = welcome;

          var goodbye = {
            type: 'instructions',
            pages: [
              'Thanks for participating in our experiment! You are all done. Please click the button to submit this HIT.'
            ],
            show_clickable_nav: true,
            on_finish: function() { sendData();}
          }
          g = tmp.num_trials + 1;
          trials[g] = goodbye;

          // add rest of trials
          for (var i = 0; i < tmp.num_trials; i++) {
            k = i+1;
            trials[k] = {type: tmp.type};
            trials[k].trial_num = i; // trial number
            trials[k].gameID = id;
            trials[k].set_size = tmp.set_size || 32;
            trials[k].num_trials = tmp.num_trials || 10;
            trials[k].target = tmp.target[i];
            trials[k].sketch = tmp.sketch[i];
            trials[k].category = tmp.category[i],
            trials[k].distractor1 = tmp.distractor1[i],
            trials[k].distractor2 = tmp.distractor2[i],
            trials[k].distractor3 = tmp.distractor3[i],
            trials[k].context = tmp.context[i],
            trials[k].draw_duration = tmp.draw_duration[i],
            trials[k].num_strokes = tmp.num_strokes[i],
            trials[k].viewer_correct_in_context = tmp.viewer_correct_in_context[i],
            trials[k].viewer_response_in_context = tmp.viewer_response_in_context[i],
            trials[k].viewer_RT_in_context = tmp.viewer_RT_in_context[i],
            trials[k].original_gameID = tmp.original_gameID[i],
            trials[k].original_trialNum = tmp.original_trialNum[i],
            trials[k].object_size = tmp.object_size || [80, 80];
            trials[k].sketch_size = tmp.sketch_size || [220, 220];
            trials[k].circle_diameter = tmp.circle_diameter || 800;
            trials[k].timing_sketch = (typeof tmp.timing_sketch === 'undefined') ? 100 : tmp.timing_sketch;
            trials[k].timing_objects = (typeof tmp.timing_objects === 'undefined') ? 1000 : tmp.timing_objects;
            trials[k].options = tmp.options || _.times(tmp.set_size,_.constant('./object/dogs_08_pug_0035.png'))
		      }

          console.log('trials',trials);

          jsPsych.init({
            timeline: trials,
            default_iti: 1000,
            show_progress_bar: true
          });

        })
      }

    window.onbeforeunload = function() {
      return "Data will be lost if you leave the page, are you sure?";
    };

    function sendData() {
      console.log('sending data to mturk');
      jsPsych.turk.submitToTurk({
        code: "code"
      });
    }

    </script>
  </head>
  <body>
    <div id="display-area"></div>

  </body>
</html>
